# TossPayments ê²°ì œ ëª¨ë“ˆ ì—°ë™ ê°€ì´ë“œ

ì´ ë¬¸ì„œëŠ” Photo4You í”„ë¡œì íŠ¸ì— TossPayments ê²°ì œ ì‹œìŠ¤í…œì„ ì—°ë™í•˜ê¸° ìœ„í•œ ì¢…í•© ê°€ì´ë“œì…ë‹ˆë‹¤.

## ğŸ“‹ ëª©ì°¨
1. [ê°œìš”](#ê°œìš”)
2. [ê²°ì œ ë°©ì‹ ì„ íƒ](#ê²°ì œ-ë°©ì‹-ì„ íƒ)
3. [í™˜ê²½ ì„¤ì •](#í™˜ê²½-ì„¤ì •)
4. [êµ¬í˜„ ë‹¨ê³„](#êµ¬í˜„-ë‹¨ê³„)
5. [ë°ì´í„°ë² ì´ìŠ¤ êµ¬ì¡°](#ë°ì´í„°ë² ì´ìŠ¤-êµ¬ì¡°)
6. [ë³´ì•ˆ ë° í…ŒìŠ¤íŠ¸](#ë³´ì•ˆ-ë°-í…ŒìŠ¤íŠ¸)

## ê°œìš”

TossPaymentsëŠ” ë‹¤ì–‘í•œ ê²°ì œ ìˆ˜ë‹¨ì„ ì§€ì›í•˜ëŠ” í†µí•© ê²°ì œ ì‹œìŠ¤í…œì…ë‹ˆë‹¤.

### ì§€ì› ê²°ì œ ìˆ˜ë‹¨
- **ì¹´ë“œ**: êµ­ë‚´ ëª¨ë“  ì‹ ìš©/ì²´í¬ì¹´ë“œ
- **ê°„í¸ê²°ì œ**: í† ìŠ¤í˜ì´, ë„¤ì´ë²„í˜ì´, ì¹´ì¹´ì˜¤í˜ì´, ì‚¼ì„±í˜ì´, ì• í”Œí˜ì´ ë“±
- **ê³„ì¢Œì´ì²´**: ì‹¤ì‹œê°„ ê³„ì¢Œì´ì²´, í€µê³„ì¢Œì´ì²´
- **ê°€ìƒê³„ì¢Œ**: ë¬´í†µì¥ ì…ê¸ˆ
- **íœ´ëŒ€í°**: íœ´ëŒ€í° ì†Œì•¡ê²°ì œ
- **ìƒí’ˆê¶Œ**: ë¬¸í™”ìƒí’ˆê¶Œ, ë„ì„œìƒí’ˆê¶Œ ë“±

### ì£¼ìš” íŠ¹ì§•
- í•œ ë²ˆì˜ ì—°ë™ìœ¼ë¡œ ëª¨ë“  ê²°ì œìˆ˜ë‹¨ ì‚¬ìš© ê°€ëŠ¥
- ë¸Œëœë“œ ì¼ê´€ì„±ì„ ìœ ì§€í•˜ëŠ” ê²°ì œ UI
- ê²°ì œ ì‹œê°„ 70% ë‹¨ì¶•ìœ¼ë¡œ ì „í™˜ìœ¨ í–¥ìƒ
- ë…¸ì½”ë“œ ì–´ë“œë¯¼ìœ¼ë¡œ ìš´ì˜ ê´€ë¦¬ ê°„ì†Œí™”

## ê²°ì œ ë°©ì‹ ì„ íƒ

Photo4You í”„ë¡œì íŠ¸ì—ëŠ” **ê²°ì œìœ„ì ¯** ë°©ì‹ì„ ê¶Œì¥í•©ë‹ˆë‹¤.

### ê²°ì œìœ„ì ¯ vs ê²°ì œì°½ ë¹„êµ

| êµ¬ë¶„ | ê²°ì œìœ„ì ¯ | ê²°ì œì°½ |
|------|---------|--------|
| **UI í†µì¼ì„±** | ë¸Œëœë“œ ì¼ê´€ì„± ìœ ì§€ | PGì‚¬ ë³„ë„ ì°½ í‘œì‹œ |
| **ê²°ì œ ë‹¨ê³„** | ì£¼ë¬¸ì„œì—ì„œ ë°”ë¡œ ê²°ì œ | ì¶”ê°€ íŒì—…/í˜ì´ì§€ í•„ìš” |
| **ê°œë°œ ê³µìˆ˜** | ìµœì†Œ (í•œ ë²ˆ ì—°ë™) | ê²°ì œìˆ˜ë‹¨ë³„ ê°œë³„ êµ¬í˜„ |
| **ìš´ì˜ ê´€ë¦¬** | ë…¸ì½”ë“œ ì–´ë“œë¯¼ ì œê³µ | ì½”ë“œ ìˆ˜ì • í•„ìš” |
| **ì¶”ì²œ ëŒ€ìƒ** | ë¸Œëœë“œ ê²½í—˜ ì¤‘ì‹œ | ë¹ ë¥¸ MVP êµ¬í˜„ |

## í™˜ê²½ ì„¤ì •

### 1. TossPayments ê³„ì • ì„¤ì •

```bash
# 1. TossPayments ê°œë°œìì„¼í„° ê°€ì…
# https://developers.tosspayments.com

# 2. API í‚¤ ë°œê¸‰
# - í…ŒìŠ¤íŠ¸ í´ë¼ì´ì–¸íŠ¸ í‚¤: test_ck_*
# - í…ŒìŠ¤íŠ¸ ì‹œí¬ë¦¿ í‚¤: test_sk_*
# - ë¼ì´ë¸Œ í´ë¼ì´ì–¸íŠ¸ í‚¤: live_ck_*
# - ë¼ì´ë¸Œ ì‹œí¬ë¦¿ í‚¤: live_sk_*
```

### 2. í™˜ê²½ ë³€ìˆ˜ ì„¤ì •

```bash
# .env.local
NEXT_PUBLIC_TOSS_CLIENT_KEY=test_ck_YOUR_KEY
TOSS_SECRET_KEY=test_sk_YOUR_KEY
NEXT_PUBLIC_TOSS_SUCCESS_URL=http://localhost:3000/payment/success
NEXT_PUBLIC_TOSS_FAIL_URL=http://localhost:3000/payment/fail
```

### 3. SDK ì„¤ì¹˜

```bash
# npm íŒ¨í‚¤ì§€ ì„¤ì¹˜
npm install @tosspayments/tosspayments-sdk --save

# ë˜ëŠ” yarn
yarn add @tosspayments/tosspayments-sdk
```

## êµ¬í˜„ ë‹¨ê³„

### 1ë‹¨ê³„: SDK ì´ˆê¸°í™”

```typescript
// lib/toss/client.ts
import { loadTossPayments } from '@tosspayments/tosspayments-sdk';

export const initTossPayments = async () => {
  const clientKey = process.env.NEXT_PUBLIC_TOSS_CLIENT_KEY!;
  return await loadTossPayments(clientKey);
};
```

### 2ë‹¨ê³„: ê²°ì œìœ„ì ¯ ì»´í¬ë„ŒíŠ¸ êµ¬í˜„

```typescript
// components/payment/payment-widget.tsx
'use client';

import { useEffect, useState } from 'react';
import { initTossPayments } from '@/lib/toss/client';
import { nanoid } from 'nanoid';

interface PaymentWidgetProps {
  amount: number;
  orderName: string;
  customerKey: string;
  customerEmail?: string;
  customerName?: string;
  customerMobilePhone?: string;
}

export function PaymentWidget({
  amount,
  orderName,
  customerKey,
  customerEmail,
  customerName,
  customerMobilePhone
}: PaymentWidgetProps) {
  const [widgets, setWidgets] = useState<any>(null);
  const [ready, setReady] = useState(false);

  useEffect(() => {
    async function setupWidgets() {
      const tossPayments = await initTossPayments();
      const widgets = tossPayments.widgets({ 
        customerKey 
      });
      
      setWidgets(widgets);
    }
    
    setupWidgets();
  }, [customerKey]);

  useEffect(() => {
    if (widgets == null) return;

    async function renderWidgets() {
      // ê²°ì œê¸ˆì•¡ ì„¤ì •
      await widgets.setAmount({
        currency: 'KRW',
        value: amount,
      });

      // ê²°ì œ ë°©ë²• ìœ„ì ¯ ë Œë”ë§
      await widgets.renderPaymentMethods({
        selector: '#payment-methods',
        variantKey: 'DEFAULT',
      });

      // ì•½ê´€ ìœ„ì ¯ ë Œë”ë§
      await widgets.renderAgreement({
        selector: '#agreement',
        variantKey: 'AGREEMENT',
      });

      setReady(true);
    }

    renderWidgets();
  }, [widgets, amount]);

  const handlePayment = async () => {
    if (!widgets) return;

    try {
      await widgets.requestPayment({
        orderId: nanoid(),
        orderName,
        successUrl: `${window.location.origin}/payment/success`,
        failUrl: `${window.location.origin}/payment/fail`,
        customerEmail,
        customerName,
        customerMobilePhone,
      });
    } catch (error) {
      console.error('ê²°ì œ ìš”ì²­ ì‹¤íŒ¨:', error);
    }
  };

  return (
    <div className="w-full max-w-2xl mx-auto p-6">
      <h2 className="text-2xl font-bold mb-6">ê²°ì œí•˜ê¸°</h2>
      
      {/* ê²°ì œ ìˆ˜ë‹¨ ì„ íƒ ì˜ì—­ */}
      <div id="payment-methods" className="mb-6" />
      
      {/* ì•½ê´€ ë™ì˜ ì˜ì—­ */}
      <div id="agreement" className="mb-6" />
      
      {/* ê²°ì œ ë²„íŠ¼ */}
      <button
        onClick={handlePayment}
        disabled={!ready}
        className="w-full py-3 px-4 bg-blue-600 text-white rounded-lg hover:bg-blue-700 disabled:opacity-50"
      >
        {amount.toLocaleString()}ì› ê²°ì œí•˜ê¸°
      </button>
    </div>
  );
}
```

### 3ë‹¨ê³„: ì„œë²„ ì¸¡ ê²°ì œ ìŠ¹ì¸ ì²˜ë¦¬

```typescript
// lib/actions/payment.ts
'use server';

import { createClient } from '@/lib/supabase/server';

interface PaymentConfirmData {
  paymentKey: string;
  orderId: string;
  amount: number;
}

export async function confirmPayment(data: PaymentConfirmData) {
  const { paymentKey, orderId, amount } = data;
  
  try {
    // TossPayments ê²°ì œ ìŠ¹ì¸ API í˜¸ì¶œ
    const response = await fetch('https://api.tosspayments.com/v1/payments/confirm', {
      method: 'POST',
      headers: {
        'Authorization': `Basic ${Buffer.from(process.env.TOSS_SECRET_KEY + ':').toString('base64')}`,
        'Content-Type': 'application/json',
      },
      body: JSON.stringify({
        paymentKey,
        orderId,
        amount,
      }),
    });

    const result = await response.json();

    if (!response.ok) {
      throw new Error(result.message || 'ê²°ì œ ìŠ¹ì¸ ì‹¤íŒ¨');
    }

    // ê²°ì œ ì •ë³´ ë°ì´í„°ë² ì´ìŠ¤ ì €ì¥
    const supabase = await createClient();
    const { error: dbError } = await supabase
      .from('payments')
      .insert({
        order_id: orderId,
        amount,
        currency: 'KRW',
        provider: 'tosspayments',
        provider_transaction_id: paymentKey,
        payment_method: result.method,
        status: 'paid',
        paid_at: new Date().toISOString(),
        buyer_name: result.card?.ownerType === 'personal' ? result.customerName : '',
        buyer_email: result.customerEmail || '',
        buyer_tel: result.customerMobilePhone || '',
        raw_response: result,
        card_info: result.card ? {
          number: result.card.number,
          cardType: result.card.cardType,
          ownerType: result.card.ownerType,
          acquireStatus: result.card.acquireStatus,
          issuerCode: result.card.issuerCode,
          acquirerCode: result.card.acquirerCode,
        } : null,
        receipt_url: result.receipt?.url || '',
      });

    if (dbError) {
      console.error('ê²°ì œ ì •ë³´ ì €ì¥ ì‹¤íŒ¨:', dbError);
      // ê²°ì œëŠ” ì„±ê³µí–ˆì§€ë§Œ DB ì €ì¥ ì‹¤íŒ¨ ì‹œ ë³„ë„ ì²˜ë¦¬
    }

    return { success: true, data: result };
  } catch (error) {
    console.error('ê²°ì œ ìŠ¹ì¸ ì—ëŸ¬:', error);
    return { 
      success: false, 
      error: error instanceof Error ? error.message : 'ê²°ì œ ìŠ¹ì¸ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.' 
    };
  }
}
```

### 4ë‹¨ê³„: ê²°ì œ ì„±ê³µ/ì‹¤íŒ¨ í˜ì´ì§€

```typescript
// app/payment/success/page.tsx
'use client';

import { useEffect, useState } from 'react';
import { useSearchParams } from 'next/navigation';
import { confirmPayment } from '@/lib/actions/payment';

export default function PaymentSuccessPage() {
  const searchParams = useSearchParams();
  const [status, setStatus] = useState<'loading' | 'success' | 'error'>('loading');
  const [message, setMessage] = useState('');

  useEffect(() => {
    async function confirm() {
      const paymentKey = searchParams.get('paymentKey');
      const orderId = searchParams.get('orderId');
      const amount = searchParams.get('amount');

      if (!paymentKey || !orderId || !amount) {
        setStatus('error');
        setMessage('ê²°ì œ ì •ë³´ê°€ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.');
        return;
      }

      const result = await confirmPayment({
        paymentKey,
        orderId,
        amount: Number(amount),
      });

      if (result.success) {
        setStatus('success');
        setMessage('ê²°ì œê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.');
      } else {
        setStatus('error');
        setMessage(result.error || 'ê²°ì œ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
      }
    }

    confirm();
  }, [searchParams]);

  return (
    <div className="min-h-screen flex items-center justify-center">
      <div className="text-center">
        {status === 'loading' && <p>ê²°ì œë¥¼ ì²˜ë¦¬í•˜ê³  ìˆìŠµë‹ˆë‹¤...</p>}
        {status === 'success' && (
          <div>
            <h1 className="text-2xl font-bold text-green-600 mb-4">ê²°ì œ ì„±ê³µ!</h1>
            <p>{message}</p>
          </div>
        )}
        {status === 'error' && (
          <div>
            <h1 className="text-2xl font-bold text-red-600 mb-4">ê²°ì œ ì‹¤íŒ¨</h1>
            <p>{message}</p>
          </div>
        )}
      </div>
    </div>
  );
}
```

### 5ë‹¨ê³„: í™˜ë¶ˆ ì²˜ë¦¬

```typescript
// lib/actions/refund.ts
'use server';

export async function cancelPayment(paymentKey: string, cancelReason: string) {
  try {
    const response = await fetch(`https://api.tosspayments.com/v1/payments/${paymentKey}/cancel`, {
      method: 'POST',
      headers: {
        'Authorization': `Basic ${Buffer.from(process.env.TOSS_SECRET_KEY + ':').toString('base64')}`,
        'Content-Type': 'application/json',
      },
      body: JSON.stringify({
        cancelReason,
      }),
    });

    const result = await response.json();

    if (!response.ok) {
      throw new Error(result.message || 'í™˜ë¶ˆ ì‹¤íŒ¨');
    }

    // í™˜ë¶ˆ ì •ë³´ DB ì €ì¥
    const supabase = await createClient();
    await supabase
      .from('refunds')
      .insert({
        payment_id: paymentKey,
        refund_type: 'full',
        refund_reason: cancelReason,
        original_amount: result.totalAmount,
        refund_amount: result.totalAmount,
        remaining_amount: 0,
        provider: 'tosspayments',
        provider_refund_id: result.cancels?.[0]?.transactionKey,
        status: 'completed',
        processed_at: new Date().toISOString(),
      });

    return { success: true, data: result };
  } catch (error) {
    console.error('í™˜ë¶ˆ ì²˜ë¦¬ ì—ëŸ¬:', error);
    return { 
      success: false, 
      error: error instanceof Error ? error.message : 'í™˜ë¶ˆ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.' 
    };
  }
}
```

## ë°ì´í„°ë² ì´ìŠ¤ êµ¬ì¡°

### payments í…Œì´ë¸” ìˆ˜ì •ì‚¬í•­

```sql
-- TossPayments ì „ìš© í•„ë“œ ì¶”ê°€
ALTER TABLE payments 
ADD COLUMN toss_payment_key VARCHAR(200),
ADD COLUMN toss_transaction_key VARCHAR(200),
ADD COLUMN toss_approval_number VARCHAR(50),
ADD COLUMN toss_easy_pay JSON, -- ê°„í¸ê²°ì œ ì •ë³´
ADD COLUMN toss_virtual_account JSON; -- ê°€ìƒê³„ì¢Œ ì •ë³´

-- ì¸ë±ìŠ¤ ì¶”ê°€
CREATE INDEX idx_payments_toss_payment_key ON payments(toss_payment_key);
```

## ë³´ì•ˆ ë° í…ŒìŠ¤íŠ¸

### ë³´ì•ˆ ì²´í¬ë¦¬ìŠ¤íŠ¸
- [ ] ì‹œí¬ë¦¿ í‚¤ëŠ” ì„œë²„ ì‚¬ì´ë“œì—ì„œë§Œ ì‚¬ìš©
- [ ] í´ë¼ì´ì–¸íŠ¸ í‚¤ëŠ” public í™˜ê²½ë³€ìˆ˜ë¡œ ê´€ë¦¬
- [ ] HTTPS í™˜ê²½ì—ì„œë§Œ ê²°ì œ ì§„í–‰
- [ ] Webhook ì„¤ì •ìœ¼ë¡œ ê²°ì œ ìƒíƒœ ë™ê¸°í™”
- [ ] ì¤‘ë³µ ê²°ì œ ë°©ì§€ ë¡œì§ êµ¬í˜„

### í…ŒìŠ¤íŠ¸ ì¹´ë“œ ì •ë³´

```javascript
// í…ŒìŠ¤íŠ¸ í™˜ê²½ì—ì„œ ì‚¬ìš© ê°€ëŠ¥í•œ ì¹´ë“œ
const testCards = {
  success: {
    number: '4330000000000004', // ìŠ¹ì¸ ì„±ê³µ
    expiry: '12/28',
    cvc: '123',
  },
  fail: {
    number: '4000000000000002', // ìŠ¹ì¸ ì‹¤íŒ¨
    expiry: '12/28',
    cvc: '123',
  },
};
```

### í…ŒìŠ¤íŠ¸ ì‹œë‚˜ë¦¬ì˜¤

1. **ì •ìƒ ê²°ì œ í”Œë¡œìš°**
   - ê²°ì œìœ„ì ¯ ë Œë”ë§ í™•ì¸
   - í…ŒìŠ¤íŠ¸ ì¹´ë“œë¡œ ê²°ì œ ì§„í–‰
   - ê²°ì œ ìŠ¹ì¸ ë° DB ì €ì¥ í™•ì¸

2. **ì—ëŸ¬ ì²˜ë¦¬**
   - ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜ ì‹œë®¬ë ˆì´ì…˜
   - ì˜ëª»ëœ ì¹´ë“œ ì •ë³´ ì…ë ¥
   - ê²°ì œ ì·¨ì†Œ ì²˜ë¦¬

3. **í™˜ë¶ˆ í”Œë¡œìš°**
   - ì „ì²´ í™˜ë¶ˆ í…ŒìŠ¤íŠ¸
   - ë¶€ë¶„ í™˜ë¶ˆ í…ŒìŠ¤íŠ¸ (ì¶”í›„ êµ¬í˜„)

## ë‹¤ìŒ ë‹¨ê³„

### ìš°ì„ ìˆœìœ„ ë†’ìŒ
1. [ ] Webhook ì—”ë“œí¬ì¸íŠ¸ êµ¬í˜„ (ê²°ì œ ìƒíƒœ ì‹¤ì‹œê°„ ë™ê¸°í™”)
2. [ ] ì •ê¸°ê²°ì œ(ë¹Œë§) ì‹œìŠ¤í…œ êµ¬í˜„
3. [ ] ê´€ë¦¬ì ëŒ€ì‹œë³´ë“œ ê²°ì œ ê´€ë¦¬ ê¸°ëŠ¥

### ìš°ì„ ìˆœìœ„ ì¤‘ê°„
1. [ ] ë¶€ë¶„ í™˜ë¶ˆ ê¸°ëŠ¥ êµ¬í˜„
2. [ ] ê²°ì œ í†µê³„ ëŒ€ì‹œë³´ë“œ
3. [ ] ë§¤ì¶œ ë¦¬í¬íŠ¸ ìƒì„±

### ìš°ì„ ìˆœìœ„ ë‚®ìŒ
1. [ ] í•´ì™¸ ê²°ì œ ì§€ì›
2. [ ] í¬ì¸íŠ¸/ì¿ í° ì‹œìŠ¤í…œ ì—°ë™
3. [ ] ê²°ì œ ì•Œë¦¼ ì»¤ìŠ¤í„°ë§ˆì´ì§•

## ì°¸ê³  ìë£Œ

- [TossPayments ê°œë°œì ë¬¸ì„œ](https://docs.tosspayments.com)
- [ê²°ì œìœ„ì ¯ ì—°ë™ ê°€ì´ë“œ](https://docs.tosspayments.com/guides/payment-widget/integration)
- [API ë ˆí¼ëŸ°ìŠ¤](https://docs.tosspayments.com/reference)
- [ì—ëŸ¬ ì½”ë“œ ëª©ë¡](https://docs.tosspayments.com/reference/error-codes)
- [ìƒ˜í”Œ í”„ë¡œì íŠ¸](https://github.com/tosspayments/payment-widget-sample)

## ì§€ì› ë° ë¬¸ì˜

- TossPayments ê³ ê°ì„¼í„°: 1544-7772
- ì´ë©”ì¼: support@tosspayments.com
- ê°œë°œì í¬ëŸ¼: https://discord.gg/tosspayments