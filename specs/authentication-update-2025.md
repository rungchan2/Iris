# Authentication System Update - 2025ë…„ 1ì›”

## ğŸ“‹ ìš”ì•½
kindtì˜ ì¸ì¦ ë° ê¶Œí•œ ì‹œìŠ¤í…œì´ ëŒ€í­ ê°„ì†Œí™”ë˜ì—ˆìŠµë‹ˆë‹¤. ë³µì¡í•œ 3-tier RBAC ì‹œìŠ¤í…œì—ì„œ 2ê°œì˜ ì™„ì „íˆ ë¶„ë¦¬ëœ ì‹œìŠ¤í…œìœ¼ë¡œ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤.

## ğŸ”„ ì£¼ìš” ë³€ê²½ì‚¬í•­

### 1. **RBAC ì‹œìŠ¤í…œ ì œê±°**
- **ì´ì „**: super_admin â†’ admin â†’ photographer ê³„ì¸µ êµ¬ì¡°
- **í˜„ì¬**: Adminê³¼ Photographer ì™„ì „ ë¶„ë¦¬

### 2. **ë°ì´í„°ë² ì´ìŠ¤ êµ¬ì¡° ë³€ê²½**

#### photographers í…Œì´ë¸”
```sql
-- role ì»¬ëŸ¼ ì œê±°ë¨
ALTER TABLE photographers DROP COLUMN IF EXISTS role;
```

#### admins í…Œì´ë¸” (ë” ì´ìƒ ì‚¬ìš© ì•ˆí•¨)
- Admin ì‚¬ìš©ìëŠ” `auth.users` í…Œì´ë¸”ì—ë§Œ ì¡´ì¬
- `user_metadata.user_type = 'admin'`ìœ¼ë¡œ ì‹ë³„

### 3. **ì¸ì¦ ì‹œìŠ¤í…œ ë¶„ë¦¬**

#### Admin ì‹œìŠ¤í…œ
- **ì €ì¥ ìœ„ì¹˜**: Supabase `auth.users` í…Œì´ë¸”ë§Œ ì‚¬ìš©
- **ì‹ë³„ ë°©ë²•**: `user_metadata.user_type === 'admin'`
- **íšŒì›ê°€ì…**: `/admin/signup` (ì´ˆëŒ€ ì½”ë“œ í•„ìš”)
- **ë¡œê·¸ì¸**: `/login` (ê³µìš©)
- **ëŒ€ì‹œë³´ë“œ ì ‘ê·¼**: ì¸ì¦ëœ ëª¨ë“  ì‚¬ìš©ì ì ‘ê·¼ ê°€ëŠ¥ (role guard ì—†ìŒ)

#### Photographer ì‹œìŠ¤í…œ
- **ì €ì¥ ìœ„ì¹˜**: `auth.users` + `photographers` í…Œì´ë¸”
- **íšŒì›ê°€ì…**: Adminì´ `/admin/users`ì—ì„œ ìƒì„±
- **ë¡œê·¸ì¸**: `/login` (ê³µìš©)
- **íŠ¹ì§•**: ì›ë˜ í”Œë¡œìš° ìœ ì§€

### 4. **ì ‘ê·¼ ê¶Œí•œ ë³€ê²½**

#### ì´ì „ ì‹œìŠ¤í…œ
```typescript
// ë³µì¡í•œ role ê¸°ë°˜ ì ‘ê·¼ ì œì–´
if (user.role === 'admin' || user.role === 'super_admin') {
  // ì ‘ê·¼ í—ˆìš©
}
```

#### í˜„ì¬ ì‹œìŠ¤í…œ
```typescript
// ë‹¨ìˆœ ì¸ì¦ í™•ì¸ë§Œ
if (session) {
  // ëª¨ë“  admin í˜ì´ì§€ ì ‘ê·¼ ê°€ëŠ¥
}
```

## ğŸ“ ìˆ˜ì •ëœ íŒŒì¼ë“¤

### 1. **Layout íŒŒì¼** (`app/admin/layout.tsx`)
```typescript
// ì´ì „
const { data: adminUser } = await supabase
  .from("photographers")
  .select("*")
  .eq("id", session.user.id)
  .single();

if (!adminUser) {
  redirect("/unauthorized");
}

// í˜„ì¬
if (!session) {
  redirect("/login");
}
// role ì²´í¬ ì—†ìŒ, ë¡œê·¸ì¸ë§Œ í™•ì¸
```

### 2. **User Management** (`lib/actions/user-management.ts`)
- `createAdminUser`: `auth.users`ì—ë§Œ ìƒì„±
- `getAdminUsers`: `auth.users`ì—ì„œ admin íƒ€ì… í•„í„°ë§
- `createPhotographerUser`: role ì²´í¬ ì œê±°
- `deleteUser`: role ì²´í¬ ì œê±°

### 3. **Admin Auth** (`lib/actions/admin-auth.ts`)
- `signupWithInviteCode`: photographers í…Œì´ë¸” ì‚½ì… ì œê±°
- `createInviteCode`: role ì²´í¬ ì œê±°
- `getInviteCodes`: role ì²´í¬ ì œê±°

### 4. **Component Updates**
- `UserManagement`: role í•„ë“œ ì œê±°
- `AdminGuard`: ì™„ì „ ì œê±° ë˜ëŠ” ë¹„í™œì„±í™”
- `Sidebar`: role ê¸°ë°˜ í•„í„°ë§ ì œê±°

## ğŸ”‘ ì´ˆëŒ€ ì½”ë“œ ì‹œìŠ¤í…œ

### Admin íšŒì›ê°€ì… í”Œë¡œìš°
1. ê¸°ì¡´ Adminì´ ì´ˆëŒ€ ì½”ë“œ ìƒì„± (`/admin/invites`)
2. ì‹ ê·œ ì‚¬ìš©ìê°€ `/admin/signup`ì—ì„œ ì´ˆëŒ€ ì½”ë“œë¡œ ê°€ì…
3. `auth.users`ì—ë§Œ ê³„ì • ìƒì„±
4. ë¡œê·¸ì¸ í›„ ëª¨ë“  admin ê¸°ëŠ¥ ì ‘ê·¼ ê°€ëŠ¥

### í…ŒìŠ¤íŠ¸ìš© ì´ˆëŒ€ ì½”ë“œ
```sql
INSERT INTO admin_invite_codes (code, expires_at, notes)
VALUES ('TEST-ADMIN-2025', '2025-12-31', 'í…ŒìŠ¤íŠ¸ìš© ê´€ë¦¬ì ì´ˆëŒ€ ì½”ë“œ');
```

## ğŸš€ Migration Guide

### ê¸°ì¡´ ì‹œìŠ¤í…œì—ì„œ ì—…ê·¸ë ˆì´ë“œ
1. **ë°ì´í„°ë² ì´ìŠ¤ ì—…ë°ì´íŠ¸**
   ```sql
   -- photographers í…Œì´ë¸”ì—ì„œ role ì»¬ëŸ¼ ì œê±°
   ALTER TABLE photographers DROP COLUMN IF EXISTS role;
   ```

2. **íƒ€ì… ì¬ìƒì„±**
   ```bash
   npx supabase gen types typescript --local > types/database.types.ts
   ```

3. **ì½”ë“œ ì—…ë°ì´íŠ¸**
   - AdminGuard ì»´í¬ë„ŒíŠ¸ ì œê±°
   - role ì²´í¬ ë¡œì§ ì œê±°
   - user-management í•¨ìˆ˜ ì—…ë°ì´íŠ¸

## ğŸ” í˜„ì¬ ì‹œìŠ¤í…œ ìƒíƒœ

### âœ… ì™„ë£Œëœ ë³€ê²½ì‚¬í•­
- photographers í…Œì´ë¸” role ì»¬ëŸ¼ ì œê±°
- ëª¨ë“  admin í˜ì´ì§€ role guard ì œê±°
- admin ì¸ì¦ì„ auth.usersë§Œ ì‚¬ìš©í•˜ë„ë¡ ë³€ê²½
- user-management.ts íŒŒì¼ ì—…ë°ì´íŠ¸
- admin layout ë‹¨ìˆœí™”

### ğŸ”„ ë‚¨ì€ ì‘ì—…
- Photographer ì „ìš© ê¸°ëŠ¥ êµ¬í˜„ (í•„ìš”ì‹œ)
- ë ˆê±°ì‹œ ì½”ë“œ ì •ë¦¬

## ğŸ’¡ ì¥ì 

1. **ë‹¨ìˆœì„±**: ë³µì¡í•œ role ê³„ì¸µ êµ¬ì¡° ì œê±°
2. **ìœ ì§€ë³´ìˆ˜ì„±**: ë‘ ì‹œìŠ¤í…œ ì™„ì „ ë¶„ë¦¬ë¡œ ê´€ë¦¬ ìš©ì´
3. **í™•ì¥ì„±**: ê° ì‹œìŠ¤í…œ ë…ë¦½ì  í™•ì¥ ê°€ëŠ¥
4. **ë³´ì•ˆ**: ë‹¨ìˆœí•œ êµ¬ì¡°ë¡œ ë³´ì•ˆ ì·¨ì•½ì  ê°ì†Œ

## âš ï¸ ì£¼ì˜ì‚¬í•­

1. **ê¸°ì¡´ ë°ì´í„°**: photographers í…Œì´ë¸”ì˜ ê¸°ì¡´ ë°ì´í„°ëŠ” ìœ ì§€ë¨
2. **ë¡œê·¸ì¸ ì¸í„°í˜ì´ìŠ¤**: Adminê³¼ Photographer ëª¨ë‘ ë™ì¼í•œ `/login` ì‚¬ìš©
3. **ê¶Œí•œ ê´€ë¦¬**: ëª¨ë“  ì¸ì¦ëœ ì‚¬ìš©ìê°€ admin ê¸°ëŠ¥ ì ‘ê·¼ ê°€ëŠ¥ (ì¶”í›„ ì œí•œ í•„ìš”ì‹œ ì¬êµ¬í˜„ í•„ìš”)

## ğŸ“Š ì‹œìŠ¤í…œ ì•„í‚¤í…ì²˜

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                 Auth System                  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚   Admin Users    â”‚   Photographer Users     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ auth.users only  â”‚ auth.users +             â”‚
â”‚                  â”‚ photographers table      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Invite code      â”‚ Admin creates via        â”‚
â”‚ signup           â”‚ /admin/users             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Full dashboard   â”‚ Limited dashboard        â”‚
â”‚ access           â”‚ access (future)          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ğŸ“ ì°¸ê³ ì‚¬í•­

- ì´ ë³€ê²½ì‚¬í•­ì€ 2025ë…„ 1ì›” 18ì¼ì— êµ¬í˜„ë˜ì—ˆìŠµë‹ˆë‹¤
- ê¸°ì¡´ RBAC ê°€ì´ë“œ(`rbac-guide.md`)ëŠ” ë ˆê±°ì‹œ ë¬¸ì„œë¡œ ìœ ì§€ë©ë‹ˆë‹¤
- ìƒˆë¡œìš´ ì‹œìŠ¤í…œì€ kindtì˜ ì‹¤ì œ ìš”êµ¬ì‚¬í•­ì— ë” ì í•©í•©ë‹ˆë‹¤