# 사연모집소 기술 스펙 문서

## 📋 문서 정보
- **버전**: v1.0
- **프로젝트**: Iris - 사연모집소
- **기술 스택**: Next.js 15 (App Router), Tailwind CSS, shadcn/ui, Supabase

---

## 1. 기술 스택

### 1.1 Core Framework
- **Next.js**: 15.x (App Router)
- **React**: 18.x
- **TypeScript**: 5.x
- **Node.js**: 20.x 이상

### 1.2 Styling
- **Tailwind CSS**: 3.x
- **shadcn/ui**: latest
- **class-variance-authority**: latest
- **tailwind-merge**: latest
- **clsx**: latest

### 1.3 Backend & Database
- **Supabase**: @supabase/supabase-js 2.x
- **Supabase SSR**: @supabase/ssr latest

### 1.4 Form & Validation
- **React Hook Form**: 7.x
- **Zod**: 3.x

### 1.5 UI Components
- **Radix UI**: (shadcn/ui 포함)
- **Lucide React**: latest (아이콘)

### 1.6 Utilities
- **date-fns**: 3.x (날짜 처리)
- **uuid**: 9.x (세션 토큰 생성)
- **js-cookie**: 3.x (쿠키 관리)

---

## 2. 패키지 설치

### 2.1 프로젝트 초기화

```bash
# Next.js 프로젝트 생성
npx create-next-app@latest iris-story --typescript --tailwind --app --no-src-dir

cd iris-story
```

### 2.2 필수 패키지 설치

```bash
# Supabase
npm install @supabase/supabase-js @supabase/ssr

# Form & Validation
npm install react-hook-form zod @hookform/resolvers

# UI Components (shadcn/ui)
npx shadcn-ui@latest init

# 개별 shadcn 컴포넌트 설치
npx shadcn-ui@latest add button
npx shadcn-ui@latest add input
npx shadcn-ui@latest add textarea
npx shadcn-ui@latest add label
npx shadcn-ui@latest add select
npx shadcn-ui@latest add dialog
npx shadcn-ui@latest add alert
npx shadcn-ui@latest add badge
npx shadcn-ui@latest add card
npx shadcn-ui@latest add toast
npx shadcn-ui@latest add separator
npx shadcn-ui@latest add checkbox
npx shadcn-ui@latest add radio-group
npx shadcn-ui@latest add progress

# Utilities
npm install date-fns uuid js-cookie
npm install -D @types/uuid @types/js-cookie

# Icons
npm install lucide-react
```

---

## 3. 프로젝트 폴더 구조

```
iris-story/
├── app/
│   ├── layout.tsx                    # Root layout
│   ├── page.tsx                      # 사연 작성 메인 페이지 ⭐
│   ├── stories/
│   │   └── page.tsx                  # 사연 리스트 페이지 (Phase 2)
│   ├── admin/
│   │   └── stories/
│   │       └── page.tsx              # 관리자 사연 승인 페이지
│   └── api/
│       └── stories/
│           └── submit/
│               └── route.ts          # 사연 제출 API (서버 사이드 전용)
│
├── components/
│   ├── ui/                           # shadcn/ui 컴포넌트
│   │   ├── button.tsx
│   │   ├── input.tsx
│   │   ├── textarea.tsx
│   │   ├── dialog.tsx
│   │   └── ...
│   ├── stories/
│   │   ├── story-form.tsx            # 사연 작성 폼
│   │   ├── image-uploader.tsx        # 이미지 업로드 컴포넌트
│   │   ├── tag-selector.tsx          # 태그 선택 컴포넌트
│   │   ├── character-counter.tsx     # 글자 수 카운터
│   │   ├── example-modal.tsx         # 작성 예시 모달
│   │   ├── coupon-modal.tsx          # 쿠폰 발급 모달
│   │   └── draft-restore-dialog.tsx  # 임시저장 복원 다이얼로그
│   └── admin/
│       └── story-moderation-table.tsx # 관리자 사연 승인 테이블
│
├── lib/
│   ├── supabase/
│   │   ├── client.ts                 # 클라이언트 Supabase 인스턴스
│   │   ├── server.ts                 # 서버 Supabase 인스턴스
│   │   └── middleware.ts             # Supabase 미들웨어
│   ├── services/
│   │   ├── stories.service.ts        # 사연 관련 DB 함수
│   │   ├── coupons.service.ts        # 쿠폰 관련 DB 함수
│   │   └── spam-detection.service.ts # 스팸 방지 로직
│   ├── utils/
│   │   ├── cn.ts                     # className 유틸리티
│   │   ├── validators.ts             # Zod 스키마
│   │   └── constants.ts              # 상수 정의
│   └── types/
│       ├── database.types.ts         # Supabase 타입 (자동 생성)
│       └── story.types.ts            # 사연 관련 타입
│
├── hooks/                            # 커스텀 훅 ⭐
│   ├── use-auto-save.ts              # 임시저장 훅
│   ├── use-session-token.ts          # 세션 토큰 관리 훅
│   ├── use-writing-timer.ts          # 작성 시간 추적 훅
│   └── use-story-submit.ts           # 사연 제출 훅
│
├── spec/                             # 프로젝트 스펙 문서 ⭐
│   ├── mvp-spec.md                   # MVP 기획서
│   ├── tech-spec.md                  # 기술 스펙 문서 (이 문서)
│   ├── database-schema.md            # DB 스키마 문서
│   └── api-spec.md                   # API 명세서
│
├── public/
│   └── images/
│       └── examples/                 # 작성 예시 이미지
│
├── .env.local                        # 환경 변수 (gitignore)
├── .env.example                      # 환경 변수 템플릿
├── middleware.ts                     # Next.js 미들웨어
├── next.config.js
├── tailwind.config.ts
├── tsconfig.json
└── package.json
```

---

## 4. 환경 변수 설정

### 4.1 `.env.local` (gitignore에 추가 필수)

```env
# Supabase - Public Keys (클라이언트에서 사용 가능)
NEXT_PUBLIC_SUPABASE_URL=https://your-project.supabase.co
NEXT_PUBLIC_SUPABASE_ANON_KEY=your-anon-key

# Supabase - Private Keys (서버 사이드 전용, 절대 노출 금지)
SUPABASE_SERVICE_ROLE_KEY=your-service-role-key

# App Configuration
NEXT_PUBLIC_APP_URL=http://localhost:3000
```

### 4.2 `.env.example` (Git에 커밋)

```env
# Supabase
NEXT_PUBLIC_SUPABASE_URL=
NEXT_PUBLIC_SUPABASE_ANON_KEY=
SUPABASE_SERVICE_ROLE_KEY=

# App Configuration
NEXT_PUBLIC_APP_URL=
```

---

## 5. 보안 가이드라인 ⚠️

### 5.1 환경 변수 보안

**✅ DO - 안전한 사용법**:
```typescript
// 클라이언트 컴포넌트 - Public Keys만 사용
'use client'
const url = process.env.NEXT_PUBLIC_SUPABASE_URL // ✅ OK
const anonKey = process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY // ✅ OK

// 서버 컴포넌트/API Route - Private Keys 사용 가능
const serviceKey = process.env.SUPABASE_SERVICE_ROLE_KEY // ✅ OK (서버 전용)
```

**❌ DON'T - 위험한 사용법**:
```typescript
// 클라이언트에서 Private Key 사용 (절대 금지!)
'use client'
const serviceKey = process.env.SUPABASE_SERVICE_ROLE_KEY // ❌ 노출 위험!
```

### 5.2 API Route 보안 패턴

**모든 민감한 작업은 API Route에서만 수행**:

```typescript
// ❌ 클라이언트에서 직접 DB 접근 (취약)
'use client'
function BadComponent() {
  const supabase = createClient()
  const handleSubmit = async () => {
    await supabase.from('stories').insert({ ... }) // ❌ RLS 우회 가능
  }
}

// ✅ API Route를 통한 접근 (안전)
'use client'
function GoodComponent() {
  const handleSubmit = async () => {
    await fetch('/api/stories/submit', {
      method: 'POST',
      body: JSON.stringify(data)
    }) // ✅ 서버 검증 거침
  }
}
```

### 5.3 사연 제출 보안 체크리스트

**서버 사이드 검증 (API Route에서 필수)**:
- [ ] IP 주소 추출 및 검증
- [ ] 세션 토큰 검증
- [ ] 작성 시간 검증
- [ ] 입력값 Sanitization
- [ ] Rate Limiting
- [ ] SQL Injection 방지 (Supabase가 자동 처리)

**클라이언트 사이드 검증 (UX 향상용)**:
- [ ] Zod 스키마 검증
- [ ] 글자 수 제한
- [ ] 이미지 크기 제한
- [ ] 파일 타입 검증

### 5.4 Row Level Security (RLS) 필수 설정

**Supabase Dashboard에서 RLS 활성화**:

```sql
-- stories 테이블
ALTER TABLE stories ENABLE ROW LEVEL SECURITY;

-- coupons 테이블
ALTER TABLE coupons ENABLE ROW LEVEL SECURITY;

-- coupon_templates 테이블
ALTER TABLE coupon_templates ENABLE ROW LEVEL SECURITY;
```

**정책 예시**:
```sql
-- 누구나 사연 제출 가능 (INSERT만)
CREATE POLICY "Anyone can submit stories"
ON stories FOR INSERT
WITH CHECK (true);

-- 본인 사연만 조회 가능
CREATE POLICY "Users can view own stories"
ON stories FOR SELECT
USING (
  auth.uid() = user_id OR
  session_token = current_setting('request.cookies.iris_session_token', true)
);
```

### 5.5 XSS 방지

**사용자 입력은 항상 Escape 처리**:

```typescript
// React가 기본적으로 XSS 방지
<div>{story.body}</div> // ✅ 자동 escape

// dangerouslySetInnerHTML 사용 금지
<div dangerouslySetInnerHTML={{ __html: story.body }} /> // ❌ 위험!

// 이미지 URL 검증
function validateImageUrl(url: string): boolean {
  return url.startsWith(process.env.NEXT_PUBLIC_SUPABASE_URL!)
}
```

### 5.6 CORS 설정

**API Route에서 CORS 제한**:

```typescript
// app/api/stories/submit/route.ts
export async function POST(request: NextRequest) {
  // Origin 검증
  const origin = request.headers.get('origin')
  const allowedOrigins = [
    process.env.NEXT_PUBLIC_APP_URL,
    'https://iris.com'
  ]
  
  if (origin && !allowedOrigins.includes(origin)) {
    return NextResponse.json(
      { error: 'Forbidden' },
      { status: 403 }
    )
  }
  
  // ... 로직
}
```

### 5.7 민감 정보 로깅 금지

```typescript
// ❌ 민감 정보 로깅 금지
console.log('User session:', sessionToken) // ❌
console.log('IP address:', ipAddress) // ❌

// ✅ 안전한 로깅
console.log('Story submitted:', storyId) // ✅
console.error('Submission failed:', { storyId, reason: 'validation' }) // ✅
```

---

## 5. Supabase 클라이언트 설정

### 5.1 `/lib/supabase/client.ts` (클라이언트 컴포넌트용)

**패턴**:
- `createBrowserClient` 사용
- Public Keys만 사용
- Database 타입 제네릭 적용

**사용 예시**:
```typescript
'use client'
import { createClient } from '@/lib/supabase/client'

function Component() {
  const supabase = createClient() // 매번 새로 생성
  // ...
}
```

### 5.2 `/lib/supabase/server.ts` (서버 컴포넌트/API용)

**패턴**:
- `createServerClient` 사용
- Cookie 핸들링 포함
- `async/await` 필수 (cookies() 사용)

**사용 예시**:
```typescript
import { createClient } from '@/lib/supabase/server'

async function ServerComponent() {
  const supabase = await createClient() // async 필수
  // ...
}
```

### 5.3 `/middleware.ts` (Supabase Auth 미들웨어)

**역할**:
- 세션 갱신
- 인증 상태 체크
- 정적 파일 제외

**매처 설정**:
- 이미지, 폰트 등 정적 파일 제외
- API Route 포함

---

## 6. 타입 정의

### 6.1 데이터베이스 타입 생성

```bash
# Supabase CLI로 타입 자동 생성
npx supabase gen types typescript --project-id kypwcsgwjtnkiiwjedcn > lib/types/database.types.ts
```

### 6.2 `/lib/types/story.types.ts`

**패턴**:
- Database 타입에서 Row/Insert/Update 추출
- 폼 데이터 타입 별도 정의
- API 요청/응답 타입 명시

**주요 타입**:
- `Story`, `StoryInsert`, `StoryUpdate`
- `StoryFormData` (폼 입력)
- `StorySubmitRequest` (API 요청)
- `StorySubmitResponse` (API 응답)
- `StoryDraft` (임시저장)

---

## 7. 상수 및 유틸리티

### 7.1 `/lib/utils/constants.ts`

**정의할 상수**:
- `STORY_TAGS`: 감정 태그 배열
- `VISIBILITY_OPTIONS`: 공개 범위 옵션
- `STORY_LIMITS`: 글자 수/이미지 제한
- `SPAM_PREVENTION`: 스팸 방지 설정
- `COOKIE_NAMES`: 쿠키 키값
- `STORAGE_KEYS`: 로컬스토리지 키값
- `DRAFT_SETTINGS`: 임시저장 설정

### 7.2 `/lib/utils/validators.ts`

**Zod 스키마 정의**:
- `storyFormSchema`: 사연 작성 폼 검증
- 각 필드별 min/max 제한
- 커스텀 에러 메시지

**패턴**:
```typescript
export const storyFormSchema = z.object({
  title: z.string().min(1).max(100),
  body: z.string().min(50).max(1000),
  // ...
})

export type StoryFormSchema = z.infer<typeof storyFormSchema>
```

---

## 8. Services (DB 함수)

### 8.1 `/lib/services/stories.service.ts`

**함수 작성 패턴**:
```typescript
// 서버 전용 함수
export async function createStory(data: StoryInsert) {
  const supabase = await createServerClient() // 매번 새로 생성
  const { data: story, error } = await supabase
    .from('stories')
    .insert(data)
    .select()
    .single()
  
  if (error) throw error
  return story
}
```

**주요 함수**:
- `createStory`: 사연 생성
- `checkRecentSubmissionBySession`: 재제출 체크
- `countSubmissionsByIP`: IP 기반 제출 수
- `countStoriesByUser/Session`: 사용자별 사연 수
- `getPendingStories`: 승인 대기 목록
- `approveStory` / `rejectStory`: 승인/거절

**원칙**:
- 모든 함수 내부에서 `createClient()` 호출
- 에러는 throw로 전파
- 타입 안전성 보장

### 8.2 `/lib/services/coupons.service.ts`

**주요 함수**:
- `issueCoupon`: 쿠폰 발급 (첫 사연 판단 포함)
- `revokeCouponsByStory`: 거절 시 쿠폰 취소
- `getUserCoupons`: 사용자 쿠폰 조회

**쿠폰 코드 생성 패턴**:
- `generateCouponCode(prefix, length)`: 랜덤 코드 생성
- 혼동 문자 제외 (0, O, I, l 등)

### 8.3 `/lib/services/spam-detection.service.ts`

**검증 순서**:
1. 세션 토큰 재제출 체크 (10분)
2. IP 기반 제출 횟수 체크 (1시간/3회)
3. 작성 시간 체크 (30초 이상)

**반환 타입**:
```typescript
interface SpamCheckResult {
  isAllowed: boolean
  reason?: string
  retryAfter?: number
}
```

---

## 9. Custom Hooks

### 9.1 `/hooks/use-session-token.ts`

**역할**: 브라우저 세션 토큰 생성/관리

**패턴**:
- UUID v4 생성
- js-cookie로 permanent cookie 저장
- useState로 상태 관리

### 9.2 `/hooks/use-writing-timer.ts`

**역할**: 작성 소요 시간 추적

**패턴**:
- useRef로 시작 시간 저장
- setInterval로 1초마다 업데이트
- cleanup 함수로 interval 정리

### 9.3 `/hooks/use-auto-save.ts`

**역할**: 로컬스토리지 임시저장

**패턴**:
- useCallback로 저장 함수 정의
- useEffect + setTimeout으로 debounce (3초)
- 제목/내용 있을 때만 저장

**추가 함수**:
- `loadDraft()`: 저장된 데이터 불러오기 (7일 이내)
- `clearDraft()`: 저장 데이터 삭제

### 9.4 `/hooks/use-story-submit.ts`

**역할**: API 호출 및 상태 관리

**패턴**:
- useState로 loading/error 관리
- fetch로 API 호출
- 에러 핸들링

---

## 10. API Route

### 10.1 `/app/api/stories/submit/route.ts`

**보안 체크리스트**:
- [ ] IP 주소 추출 (`x-forwarded-for` 헤더)
- [ ] Origin 검증 (CORS)
- [ ] 스팸 검증 (`validateSubmission`)
- [ ] 입력값 검증 (Zod 스키마)
- [ ] Rate Limiting

**처리 순서**:
1. Request Body 파싱
2. IP 주소 추출
3. 스팸 검증
4. 사연 저장 (의심 플래그 포함)
5. 쿠폰 발급
6. 응답 반환

**에러 응답 패턴**:
```typescript
if (!spamCheck.isAllowed) {
  return NextResponse.json(
    {
      success: false,
      error: spamCheck.reason,
      message: getErrorMessage(spamCheck.reason),
      retryAfter: spamCheck.retryAfter
    },
    { status: 429 } // Too Many Requests
  )
}
```

--- story.visibility,
      author_name: story.authorName,
      user_id: userId,
      session_token: session.token,
      ip_address: ip,
      user_agent: request.headers.get('user-agent') || '',
      writing_duration_sec: session.writingDuration,
      submitted_from_url: session.referer,
      is_suspicious: isSuspicious,
      suspicious_reason: isSuspicious ? 'fast_writing' : null,
      moderation_status: 'pending'
    })
    
    // 쿠폰 발급
    const couponData = await issueCoupon(
      savedStory.id,
      userId,
      session.token
    )
    
    const response: StorySubmitResponse = {
      success: true,
      story: {
        id: savedStory.id,
        title: savedStory.title,
        createdAt: savedStory.created_at
      },
      coupon: {
        code: couponData.code,
        discount: `${couponData.template.discount_value}${
          couponData.template.discount_type === 'percentage' ? '%' : '원'
        }`,
        validUntil: couponData.valid_until,
        terms: couponData.template.terms_description || ''
      }
    }
    
    return NextResponse.json(response)
    
  } catch (error) {
    console.error('Story submission error:', error)
    
    const response: StorySubmitResponse = {
      success: false,
      error: 'INTERNAL_ERROR',
      message: '서버 오류가 발생했습니다'
    }
    
    return NextResponse.json(response, { status: 500 })
  }
}

function getErrorMessage(errorCode: string): string {
  const messages: Record<string, string> = {
    TOO_FREQUENT: '10분 후 다시 제출할 수 있습니다',
    RATE_LIMIT_EXCEEDED: '잠시 후 다시 시도해주세요',
    SUSPICIOUS_SPEED: '작성 시간이 너무 짧습니다. 다시 시도해주세요'
  }
  
  return messages[errorCode] || '제출에 실패했습니다'
}
```

---

## 11. 개발 가이드라인

### 11.1 Supabase 클라이언트 사용 규칙

**서버 컴포넌트 / API Route**:
```typescript
import { createClient } from '@/lib/supabase/server'

async function ServerComponent() {
  const supabase = await createClient() // 항상 새로 생성
  // ...
}
```

**클라이언트 컴포넌트**:
```typescript
'use client'
import { createClient } from '@/lib/supabase/client'

function ClientComponent() {
  const supabase = createClient() // 항상 새로 생성
  // ...
}
```

### 11.2 Services 함수 작성 규칙

**패턴**:
1. 모든 함수는 내부에서 `createClient()` 호출
2. 서버 함수와 클라이언트 함수 명확히 구분
3. 에러는 throw로 전파
4. 타입은 `database.types.ts`에서 import

**예시**:
```typescript
// ✅ 올바른 패턴
export async function someFunction() {
  const supabase = await createClient() // 함수 내부에서 생성
  const { data, error } = await supabase.from('table').select()
  if (error) throw error
  return data
}

// ❌ 잘못된 패턴
const supabase = createClient() // 파일 최상단에서 생성 금지
export async function someFunction() {
  // ...
}
```

### 11.3 컴포넌트 구조 가이드라인

**클라이언트 컴포넌트**:
- 'use client' 지시문 명시
- 커스텀 훅 사용
- API Route로 데이터 전송
- 직접 DB 접근 금지 (보안)

**서버 컴포넌트**:
- 데이터 fetching 담당
- Services 함수 직접 호출 가능
- useState/useEffect 사용 불가

### 11.4 에러 핸들링 패턴

**Services 레이어**:
```typescript
export async function getData() {
  const supabase = await createClient()
  const { data, error } = await supabase.from('table').select()
  
  if (error) throw error // throw로 전파
  return data
}
```

**API Route**:
```typescript
export async function GET() {
  try {
    const data = await getData()
    return NextResponse.json({ success: true, data })
  } catch (error) {
    console.error('Error:', error)
    return NextResponse.json(
      { success: false, error: 'Internal error' },
      { status: 500 }
    )
  }
}
```

**클라이언트 컴포넌트**:
```typescript
'use client'
function Component() {
  const [error, setError] = useState<string | null>(null)
  
  const handleSubmit = async () => {
    try {
      const response = await fetch('/api/endpoint')
      const result = await response.json()
      
      if (!result.success) {
        setError(result.error)
      }
    } catch (err) {
      setError('네트워크 오류가 발생했습니다')
    }
  }
}
```

### 11.5 타입 안전성 가이드

**Database 타입 활용**:
```typescript
import { Database } from '@/lib/types/database.types'

type Story = Database['public']['Tables']['stories']['Row']
type StoryInsert = Database['public']['Tables']['stories']['Insert']
```

**Zod 스키마 활용**:
```typescript
import { storyFormSchema } from '@/lib/utils/validators'

// 클라이언트 검증
const result = storyFormSchema.safeParse(formData)
if (!result.success) {
  console.error(result.error.flatten())
}

// 서버 검증
const validated = storyFormSchema.parse(body)
```

### 11.6 임포트 순서 규칙

```typescript
// 1. External libraries
import { useState } from 'react'
import { createClient } from '@supabase/ssr'

// 2. Internal libraries
import { createClient } from '@/lib/supabase/client'
import { createStory } from '@/lib/services/stories.service'

// 3. Components
import { Button } from '@/components/ui/button'
import StoryForm from '@/components/stories/story-form'

// 4. Types
import type { Story, StoryFormData } from '@/lib/types/story.types'

// 5. Utils
import { cn } from '@/lib/utils/cn'
import { STORY_TAGS } from '@/lib/utils/constants'
```

### 11.7 파일 명명 규칙

**컴포넌트**: `kebab-case.tsx`
- `story-form.tsx`
- `image-uploader.tsx`

**Services**: `kebab-case.service.ts`
- `stories.service.ts`
- `coupons.service.ts`

**Hooks**: `use-kebab-case.ts`
- `use-session-token.ts`
- `use-auto-save.ts`

**Types**: `kebab-case.types.ts`
- `story.types.ts`
- `database.types.ts`

**Utils**: `kebab-case.ts`
- `validators.ts`
- `constants.ts`

---

## 12. 테스트 가이드라인

### 12.1 수동 테스트 체크리스트

**사연 작성 플로우**:
- [ ] 페이지 첫 진입 시 세션 토큰 생성 확인
- [ ] 임시저장 자동 동작 확인 (3초 debounce)
- [ ] 임시저장 복원 확인 (페이지 재방문)
- [ ] 글자 수 카운터 실시간 업데이트
- [ ] 50자 미만 시 제출 버튼 비활성화
- [ ] 이미지 업로드 (최대 3장, 5MB 제한)
- [ ] 태그 선택 (최대 3개)
- [ ] 제출 성공 시 쿠폰 모달 표시
- [ ] beforeunload 경고 동작 확인

**스팸 방지**:
- [ ] 10분 내 재제출 차단 확인
- [ ] 1시간 내 동일 IP 3회 제출 차단
- [ ] 30초 미만 작성 시 의심 플래그
- [ ] reCAPTCHA 표시 (빠른 작성 시)

**관리자 기능**:
- [ ] 대기 중인 사연 목록 조회
- [ ] 의심스러운 사연 우선 표시
- [ ] 사연 승인/거절
- [ ] 거절 시 쿠폰 자동 취소

### 12.2 브라우저 테스트

**필수 브라우저**:
- Chrome (최신)
- Safari (최신)
- Firefox (최신)
- Mobile Safari (iOS)
- Chrome Mobile (Android)

**테스트 항목**:
- localStorage 동작
- Cookie 설정
- beforeunload 이벤트
- 이미지 업로드

---

## 13. 배포 가이드라인

### 13.1 환경 변수 설정 (Vercel)

```bash
# Production 환경 변수
NEXT_PUBLIC_SUPABASE_URL=https://prod.supabase.co
NEXT_PUBLIC_SUPABASE_ANON_KEY=prod-anon-key
SUPABASE_SERVICE_ROLE_KEY=prod-service-role-key
NEXT_PUBLIC_APP_URL=https://iris.com
```

### 13.2 빌드 전 체크리스트

- [ ] TypeScript 에러 없음 (`npm run build`)
- [ ] ESLint 에러 없음 (`npm run lint`)
- [ ] 환경 변수 설정 완료
- [ ] Supabase RLS 정책 활성화
- [ ] 초기 데이터 삽입 완료 (쿠폰 템플릿)
- [ ] Database 타입 최신화

### 13.3 배포 후 확인사항

- [ ] API Route 정상 동작
- [ ] 사연 제출 정상 작동
- [ ] 쿠폰 발급 정상 작동
- [ ] 관리자 페이지 접근 제한
- [ ] 스팸 방지 로직 동작
- [ ] 에러 로깅 확인

---

## 14. 성능 최적화 가이드

### 14.1 이미지 최적화

**Next.js Image 컴포넌트 사용**:
```typescript
import Image from 'next/image'

<Image
  src={imageUrl}
  alt="story image"
  width={800}
  height={600}
  quality={85}
  placeholder="blur"
/>
```

**Supabase Storage 최적화**:
- 이미지 리사이징 (`transform` API)
- WebP 변환
- CDN 캐싱

### 14.2 번들 크기 최적화

**Dynamic Import**:
```typescript
// 예시 모달 컴포넌트 lazy loading
const ExampleModal = dynamic(() => import('./example-modal'), {
  loading: () => <Skeleton />
})
```

**Tree Shaking**:
- Named import 사용
- Barrel export 지양

### 14.3 Database 쿼리 최적화

**Select 최적화**:
```typescript
// ❌ 모든 컬럼 조회
const { data } = await supabase.from('stories').select('*')

// ✅ 필요한 컬럼만 조회
const { data } = await supabase
  .from('stories')
  .select('id, title, created_at')
```

**인덱스 활용**:
- 자주 조회하는 컬럼에 인덱스 생성
- Composite index 고려

---

## 15. 모니터링 및 로깅

### 15.1 에러 모니터링

**추천 도구**:
- Sentry
- LogRocket
- Vercel Analytics

**구현 패턴**:
```typescript
try {
  // 로직
} catch (error) {
  console.error('Story submission failed:', {
    storyId,
    error: error.message,
    timestamp: new Date().toISOString()
  })
  
  // 에러 모니터링 서비스로 전송
  // Sentry.captureException(error)
}
```

### 15.2 성능 모니터링

**Core Web Vitals**:
- LCP (Largest Contentful Paint)
- FID (First Input Delay)
- CLS (Cumulative Layout Shift)

**Vercel Analytics**:
```typescript
// app/layout.tsx
import { Analytics } from '@vercel/analytics/react'

export default function RootLayout({ children }) {
  return (
    <html>
      <body>
        {children}
        <Analytics />
      </body>
    </html>
  )
}
```

### 15.3 커스텀 이벤트 트래킹

**주요 이벤트**:
- 사연 제출 성공/실패
- 쿠폰 발급
- 임시저장 사용
- 작성 소요 시간

**구현 예시**:
```typescript
// 사연 제출 성공 시
trackEvent('story_submitted', {
  storyId,
  writingDuration,
  hasImages: images.length > 0,
  tagCount: tags.length
})
```

---

## 16. 문서 참조

### 16.1 프로젝트 스펙 문서

모든 기획 및 기술 스펙은 `/spec` 폴더에서 확인:

```
/spec/
├── mvp-spec.md              # MVP 기획서
├── tech-spec.md             # 기술 스펙 문서 (이 문서)
├── database-schema.md       # DB 스키마 상세
└── api-spec.md              # API 명세서
```

### 16.2 외부 문서

**Next.js**:
- [App Router 공식 문서](https://nextjs.org/docs/app)
- [API Routes](https://nextjs.org/docs/app/building-your-application/routing/route-handlers)

**Supabase**:
- [JavaScript Client 문서](https://supabase.com/docs/reference/javascript)
- [Auth 문서](https://supabase.com/docs/guides/auth)
- [Storage 문서](https://supabase.com/docs/guides/storage)

**shadcn/ui**:
- [컴포넌트 문서](https://ui.shadcn.com)

---

## 17. 개발 워크플로우

### 17.1 브랜치 전략

```
main (production)
  └── develop (staging)
       ├── feature/story-form
       ├── feature/coupon-system
       └── feature/admin-panel
```

### 17.2 커밋 컨벤션

```
feat: 새로운 기능 추가
fix: 버그 수정
docs: 문서 수정
style: 코드 포맷팅 (기능 변경 없음)
refactor: 코드 리팩토링
test: 테스트 코드
chore: 빌드 설정, 패키지 매니저
```

**예시**:
```bash
git commit -m "feat: 사연 작성 폼 컴포넌트 구현"
git commit -m "fix: 임시저장 복원 버그 수정"
git commit -m "docs: API 명세서 업데이트"
```

### 17.3 Pull Request 템플릿

```markdown
## 변경 사항
- 구현한 기능 또는 수정한 버그 설명

## 테스트 완료 항목
- [ ] 로컬 환경 테스트
- [ ] TypeScript 에러 없음
- [ ] ESLint 통과

## 관련 이슈
- #123

## 스크린샷 (UI 변경 시)
```

---

## 18. 트러블슈팅 가이드

### 18.1 Supabase 연결 실패

**증상**: "Invalid API key" 또는 연결 에러

**해결 방법**:
1. `.env.local` 환경 변수 확인
2. Supabase Dashboard에서 키 재확인
3. 서버 재시작 (`npm run dev`)

### 18.2 RLS 정책 에러

**증상**: "new row violates row-level security policy"

**해결 방법**:
1. Supabase Dashboard에서 RLS 정책 확인
2. `service_role` 키 사용 여부 확인
3. 정책 조건 재검토

### 18.3 타입 에러

**증상**: TypeScript 타입 불일치

**해결 방법**:
1. Database 타입 재생성
   ```bash
   npx supabase gen types typescript --project-id kypwcsgwjtnkiiwjedcn > lib/types/database.types.ts
   ```
2. IDE 재시작
3. `node_modules` 삭제 후 재설치

### 18.4 Cookie 설정 에러

**증상**: 세션 토큰이 저장되지 않음

**해결 방법**:
1. 브라우저 쿠키 설정 확인
2. SameSite 속성 확인
3. HTTPS 환경에서 Secure 속성 필요

---

## 19. 다음 단계

### 19.1 Phase 1 개발 순서

1. ✅ 프로젝트 초기 설정
2. ✅ Supabase 연동
3. ✅ 타입 생성
4. ⬜ DB 테이블 생성
5. ⬜ Services 함수 구현
6. ⬜ Custom Hooks 구현
7. ⬜ API Route 구현
8. ⬜ UI 컴포넌트 구현
9. ⬜ 사연 작성 페이지 구현
10. ⬜ 관리자 페이지 구현
11. ⬜ 테스트 및 배포

### 19.2 개발 시작하기

```bash
# 1. 의존성 설치
npm install

# 2. 환경 변수 설정
cp .env.example .env.local
# .env.local 파일 수정

# 3. Database 타입 생성
npx supabase gen types typescript --project-id kypwcsgwjtnkiiwjedcn > lib/types/database.types.ts

# 4. 개발 서버 실행
npm run dev
```

### 19.3 체크리스트

**필수 작업**:
- [ ] `/spec` 폴더에 문서 정리
- [ ] `.env.example` 파일 생성
- [ ] `.gitignore`에 `.env.local` 추가
- [ ] Supabase 테이블 생성
- [ ] RLS 정책 활성화
- [ ] 초기 데이터 삽입
- [ ] 첫 번째 컴포넌트 구현

---

**문서 종료**

이 문서는 `/spec/tech-spec.md`에 저장하여 참조용으로 사용하세요.