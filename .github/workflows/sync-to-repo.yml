name: ì¬ì˜ë ˆí¬ì— ë³µì œ

on:
  push:
    branches:
      - main

jobs:
  sync-to-fork:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout your code
        uses: actions/checkout@v3

      - name: Add friend's repo and push
        run: |
          # ë””ë²„ê¹…: í† í°ì´ ì„¤ì •ë˜ì–´ ìˆëŠ”ì§€ í™•ì¸ (ì‹¤ì œ ê°’ì€ í‘œì‹œí•˜ì§€ ì•ŠìŒ)
          if [ -z "${{ secrets.FRIEND_PAT }}" ]; then
            echo "âŒ FRIEND_PATì´ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤!"
            exit 1
          else
            echo "âœ… FRIEND_PATì´ ì„¤ì •ë˜ì–´ ìˆìŠµë‹ˆë‹¤."
          fi
          
          # ğŸ” PAT í† í°ì´ ì–´ë–¤ ì‚¬ìš©ìì¸ì§€ í™•ì¸
          echo "ğŸ” PAT í† í° ì‚¬ìš©ì í™•ì¸ ì¤‘..."
          TOKEN_USER=$(curl -s -H "Authorization: token ${{ secrets.FRIEND_PAT }}" \
               -H "Accept: application/vnd.github.v3+json" \
               https://api.github.com/user | jq -r '.login // "í† í° ì˜¤ë¥˜"')
          echo "ğŸ¯ í† í° ì†Œìœ ì: $TOKEN_USER"
          
          # Git credential ê°•ì œ ì„¤ì • (github-actions[bot] ìš°íšŒ)
          echo "ğŸ”§ Git credential ê°•ì œ ì„¤ì • ì¤‘..."
          git config --global credential.helper ""
          git config --global --unset-all credential.helper || true
          
          # ëª…ì‹œì ìœ¼ë¡œ credential ì„¤ì •
          git config --global credential.helper store
          echo "https://$TOKEN_USER:${{ secrets.FRIEND_PAT }}@github.com" > ~/.git-credentials
          
          # Git ì‚¬ìš©ì ì •ë³´ ì„¤ì •
          git config --global user.name "$TOKEN_USER"
          git config --global user.email "actions@github.com"
          
          # Public ë ˆí¬ì§€í† ë¦¬ ì ‘ê·¼ í…ŒìŠ¤íŠ¸
          echo "ğŸ” Public ë ˆí¬ì§€í† ë¦¬ ì ‘ê·¼ í…ŒìŠ¤íŠ¸..."
          if git ls-remote https://github.com/sunsetcinematic/sunset-cinema.git; then
            echo "âœ… ë ˆí¬ì§€í† ë¦¬ ì ‘ê·¼ ì„±ê³µ! (Public ëª¨ë“œ)"
          else
            echo "âŒ ë ˆí¬ì§€í† ë¦¬ ì ‘ê·¼ ì‹¤íŒ¨"
            exit 1
          fi
          
          # Friend ë ˆí¬ì§€í† ë¦¬ ì¶”ê°€ ë° í‘¸ì‹œ
          echo "ğŸ“¤ Friend ë ˆí¬ì§€í† ë¦¬ì— í‘¸ì‹œ ì¤‘..."
          
          # ë°©ë²• 1: credential helper ì‚¬ìš© (ì¶”ì²œ)
          echo "ğŸ”„ ë°©ë²• 1: Git credential helper ì‚¬ìš©"
          if git remote add friend https://github.com/sunsetcinematic/sunset-cinema.git 2>/dev/null; then
            if git push friend main --force; then
              echo "âœ… ë°©ë²• 1 ì„±ê³µ! (credential helper)"
              exit 0
            else
              echo "âŒ ë°©ë²• 1 í‘¸ì‹œ ì‹¤íŒ¨"
              git remote remove friend || true
            fi
          fi
          
          # ë°©ë²• 2: URLì— í† í° ì§ì ‘ í¬í•¨
          echo "ğŸ”„ ë°©ë²• 2: URLì— í† í° ì§ì ‘ í¬í•¨"
          if git remote add friend2 https://$TOKEN_USER:${{ secrets.FRIEND_PAT }}@github.com/sunsetcinematic/sunset-cinema.git 2>/dev/null; then
            if git push friend2 main --force; then
              echo "âœ… ë°©ë²• 2 ì„±ê³µ! (URL í† í°)"
              exit 0
            else
              echo "âŒ ë°©ë²• 2 í‘¸ì‹œ ì‹¤íŒ¨"
            fi
          fi
          
          # ë°©ë²• 3: x-access-token ë°©ì‹
          echo "ğŸ”„ ë°©ë²• 3: x-access-token ë°©ì‹"
          if git remote add friend3 https://x-access-token:${{ secrets.FRIEND_PAT }}@github.com/sunsetcinematic/sunset-cinema.git 2>/dev/null; then
            if git push friend3 main --force; then
              echo "âœ… ë°©ë²• 3 ì„±ê³µ! (x-access-token)"
              exit 0
            else
              echo "âŒ ë°©ë²• 3 í‘¸ì‹œ ì‹¤íŒ¨"
            fi
          fi
          
          echo "âŒ ëª¨ë“  ë°©ë²• ì‹¤íŒ¨ - í† í° ê¶Œí•œì„ ë‹¤ì‹œ í™•ì¸í•´ì£¼ì„¸ìš”"
          exit 1
        
        # SSH ë°©ì‹ ëŒ€ì•ˆ (í•„ìš”ì‹œ ì‚¬ìš©):
        # git remote add friend git@github.com:sunsetcinematic/sunset-cinema.git
        # (SSH í‚¤ ì„¤ì • í•„ìš”)